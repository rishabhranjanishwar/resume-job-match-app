<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Match Results</title>
  <style>
    :root{
      --primary:#0a63c7; --primary-light:#e9f2ff; --card:#fff; --muted:#6b7280;
      --radius:10px;
    }
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,#f6f9fb,#f1f6fb); color:#111; padding:36px 20px;}
    .wrapper{ max-width:1100px; margin:0 auto; }
    .top { text-align:center; margin-bottom:18px; }
    .top h1{ font-size:34px; margin-bottom:6px; }
    .card { background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:0 6px 18px rgba(20,30,60,0.06); border:1px solid #eef2f6; }
    .summary { display:flex; gap:14px; margin-bottom:18px; }
    .summary .box{ flex:1; background:var(--primary-light); border:1px solid #cfe3ff; border-radius:8px; padding:22px; text-align:center; }
    .summary .box h2{ color:var(--primary); font-size:28px; margin-bottom:6px; }
    .summary .box p{ font-size:12px; color:var(--muted); letter-spacing:0.08em; text-transform:uppercase; }
    .controls { display:flex; gap:12px; align-items:center; margin-bottom:14px; }
    .controls input[type="range"]{ flex:1; }
    .results-list{ margin-top:12px; }
    .resume-row{ display:flex; justify-content:space-between; align-items:center; padding:18px; border-radius:8px; background:#fff; border:1px solid #f1f5f9; margin-bottom:10px; }
    .filename{ font-weight:600; color:#111; }
    .right-col{ display:flex; gap:12px; align-items:center; }
    .match-badge{ padding:8px 12px; border-radius:8px; font-weight:700; }
    .fit { background: #e6fff0; color:#0a7a2b; border:1px solid #bfe9d0;}
    .partial { background:#fff8e6; color:#a36b00; border:1px solid #f1dca8;}
    .notfit { background:#fff1f1; color:#c21b1b; border:1px solid #f5c6c6;}
    .match-percent { font-size:18px; color:var(--primary); font-weight:800; }
    .small { font-size:12px; color:var(--muted); text-align:center; }
    .muted { color:var(--muted); font-size:13px; }
    .submit-btn{ background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700;}
    @media (max-width:760px){ .summary{ flex-direction:column; } .controls{ flex-direction:column; align-items:flex-start;} .right-col{ flex-direction:column; } }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="top">
      <h1>Match Results</h1>
      <div class="muted">Resume analysis complete</div>
    </div>

    <div class="card">
      <!-- Summary cards (server-side counts) -->
      <div class="summary">
        <div class="box">
          <h2 id="totalCount">{{ counts.total }}</h2>
          <p>Resumes Analyzed</p>
        </div>
        <div class="box">
          <h2 id="strongCount">{{ counts.strong }}</h2>
          <p>Strong Matches</p>
        </div>
        <div class="box">
          <h2 id="partialCount">{{ counts.partial }}</h2>
          <p>Partial Matches</p>
        </div>
      </div>

      <!-- Threshold controls: change and submit back to server -->
      <form id="thresholdForm" action="{{ url_for('apply_threshold') }}" method="POST" class="controls">
        <!-- current threshold is prefilled by server -->
        <label class="small" style="min-width:160px;">Strong cutoff (≥)</label>
        <input id="thresholdRange" type="range" min="0" max="100" value="{{ threshold_percent }}" />
        <input id="thresholdNumber" type="number" name="threshold_percent" min="0" max="100" value="{{ threshold_percent }}" style="width:80px" />
        <div class="small">Partial if ≥ {{ partial_cutoff }}% and &lt; <span id="thresholdLabel">{{ threshold_percent }}</span>%</div>
        <button type="submit" class="submit-btn">Apply cutoff (server)</button>
      </form>

      <!-- Results listing -->
      <div class="results-list" id="resultsList">
        {% for r in resumes %}
          {# normalize value robustly: use float conversion and scale if <=1 #}
          {% set raw = (r.match|float) %}
          {% if raw <= 1 %}
            {% set mp = (raw * 100) | round(2) %}
          {% else %}
            {% set mp = raw | round(2) %}
          {% endif %}
          <div class="resume-row" data-match="{{ mp }}" data-filename="{{ r.filename }}">
            <div class="left-col">
              <div class="filename">{{ r.filename }}</div>
              <div class="muted">details...</div>
            </div>

            <div class="right-col">
              <div class="match-percent" title="{{ mp }}%">{{ mp }}%</div>
              {% if r.category is defined %}
                <div class="match-badge {{ 'fit' if r.category == 'strong' else ('partial' if r.category == 'partial' else 'notfit') }}">
                  {{ 'FIT' if r.category == 'strong' else ('PARTIAL' if r.category == 'partial' else 'NOT FIT') }}
                </div>
              {% else %}
                <div class="match-badge" id="badge-{{ loop.index0 }}">-</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    (function(){
      // DOM references
      const range = document.getElementById('thresholdRange');
      const number = document.getElementById('thresholdNumber');
      const thresholdLabel = document.getElementById('thresholdLabel');
      const totalCountEl = document.getElementById('totalCount');
      const strongCountEl = document.getElementById('strongCount');
      const partialCountEl = document.getElementById('partialCount');

      // partial_cutoff was passed from server; if not present, default to 40
      const partialCutoff = {{ partial_cutoff|default(40) }};

      function normalize(n){
        const f = Number(n);
        if (isNaN(f)) return 0;
        return Math.max(0, Math.min(100, Math.round(f * 100) / 100));
      }

      function classifyAndRender(threshold){
        threshold = Number(threshold);
        thresholdLabel.textContent = threshold;
        const rows = Array.from(document.querySelectorAll('.resume-row'));
        let total = rows.length, strong=0, partial=0;
        rows.forEach((row, idx) => {
          const m = normalize(row.getAttribute('data-match'));
          const badgeEl = row.querySelector('.match-badge');
          if (m >= threshold){
            strong++; if (badgeEl) { badgeEl.textContent = 'FIT'; badgeEl.className = 'match-badge fit'; }
          } else if (m >= partialCutoff){
            partial++; if (badgeEl) { badgeEl.textContent = 'PARTIAL'; badgeEl.className = 'match-badge partial'; }
          } else {
            if (badgeEl) { badgeEl.textContent = 'NOT FIT'; badgeEl.className = 'match-badge notfit'; }
          }
        });
        if (totalCountEl) totalCountEl.textContent = total;
        if (strongCountEl) strongCountEl.textContent = strong;
        if (partialCountEl) partialCountEl.textContent = partial;
      }

      // sync range <-> number
      range.addEventListener('input', e => {
        number.value = e.target.value;
        classifyAndRender(e.target.value);
      });
      number.addEventListener('change', e => {
        let v = Number(e.target.value);
        if (isNaN(v)) v = {{ threshold_percent }};
        v = Math.max(0, Math.min(100, Math.round(v)));
        number.value = v; range.value = v;
        classifyAndRender(v);
      });

      // initial classification with server-provided threshold
      classifyAndRender({{ threshold_percent }});
    })();
  </script>
</body>
</html>
